#!/bin/bash

echo "
 ██ ███████ ██████  ███████ ███████        █████  ███    ███ ██████  ██  
██  ██      ██   ██ ██      ██            ██   ██ ████  ████ ██   ██  ██ 
██  █████   ██████  █████   ███████ █████ ███████ ██ ████ ██ ██   ██  ██ 
██  ██      ██      ██           ██       ██   ██ ██  ██  ██ ██   ██  ██ 
 ██ ██      ██      ███████ ███████       ██   ██ ██      ██ ██████  ██  
                                                                         
"
echo "Sets up Ubuntu 24.04 with systemd support for Pterodactyl Panel/Wings"
echo "This container will support systemctl and can run services properly"
echo ""
read -p "Are you sure you want to proceed? (y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Installation aborted."
    exit 1
fi

# Create Dockerfile
cat <<'EOF' > Dockerfile
FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV container=docker

# Install systemd and essential packages
RUN apt-get update && \
    apt-get install -y \
    systemd \
    systemd-sysv \
    dbus \
    dbus-user-session \
    nano \
    neofetch \
    curl \
    wget \
    ca-certificates \
    gnupg \
    lsb-release \
    sudo \
    net-tools \
    iputils-ping \
    openssh-server \
    software-properties-common && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Set root password
RUN echo 'root:root' | chpasswd

# Enable SSH login for root
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Configure systemd - keep only essential services
RUN cd /lib/systemd/system/sysinit.target.wants/ && \
    ls | grep -v systemd-tmpfiles-setup | xargs rm -f && \
    rm -f /lib/systemd/system/multi-user.target.wants/* && \
    rm -f /etc/systemd/system/*.wants/* && \
    rm -f /lib/systemd/system/local-fs.target.wants/* && \
    rm -f /lib/systemd/system/sockets.target.wants/*udev* && \
    rm -f /lib/systemd/system/sockets.target.wants/*initctl* && \
    rm -f /lib/systemd/system/basic.target.wants/* && \
    rm -f /lib/systemd/system/anaconda.target.wants/*

# Enable getty on tty1 for console login
RUN systemctl set-default multi-user.target && \
    systemctl enable getty@tty1.service

# Fix unprivileged port access issue
RUN echo "net.ipv4.ip_unprivileged_port_start=0" >> /etc/sysctl.conf

# Create a startup script
RUN echo '#!/bin/bash' > /startup.sh && \
    echo 'sysctl -w net.ipv4.ip_unprivileged_port_start=0 2>/dev/null || true' >> /startup.sh && \
    echo 'exec /sbin/init' >> /startup.sh && \
    chmod +x /startup.sh

# Set working directory
WORKDIR /root

# Expose common ports for Pterodactyl and SSH
EXPOSE 22 80 443 8080 2022

STOPSIGNAL SIGRTMIN+3

ENTRYPOINT ["/startup.sh"]
EOF

echo "Building Docker image (this may take a few minutes)..."
docker build -t ubuntu24-systemd . 2>&1 | grep -v "^#" | tail -20

if [ $? -eq 0 ]; then
    echo "✓ Done installing!"
    echo ""
    echo "
 ██ ██████  ██    ██ ███    ██ ███    ██ ██ ███    ██  ██████      ██████  ███████ ██  
██  ██   ██ ██    ██ ████   ██ ████   ██ ██ ████   ██ ██           ██   ██ ██       ██ 
██  ██████  ██    ██ ██ ██  ██ ██ ██  ██ ██ ██ ██  ██ ██   ███     ██████  █████    ██ 
██  ██   ██ ██    ██ ██  ██ ██ ██  ██ ██ ██ ██  ██ ██ ██    ██     ██      ██       ██ 
 ██ ██   ██  ██████  ██   ████ ██   ████ ██ ██   ████  ██████      ██      ███████ ██  
    "
    echo "Container Details:"
    echo "  • Username: root"
    echo "  • Password: root"
    echo "  • OS: Ubuntu 24.04"
    echo "  • Systemd: Enabled"
    echo "  • SSH: Port 2222 (mapped from 22)"
    echo ""
    echo "Starting container in detached mode..."
    
    # Stop and remove old container if exists
    docker stop pterodactyl-container 2>/dev/null
    docker rm pterodactyl-container 2>/dev/null
    
    # Find available ports
    SSH_PORT=2222
    HTTP_PORT=8080
    HTTPS_PORT=8443
    
    while netstat -tuln 2>/dev/null | grep -q ":$SSH_PORT " || lsof -i :$SSH_PORT 2>/dev/null | grep -q LISTEN; do
        SSH_PORT=$((SSH_PORT + 1))
    done
    
    while netstat -tuln 2>/dev/null | grep -q ":$HTTP_PORT " || lsof -i :$HTTP_PORT 2>/dev/null | grep -q LISTEN; do
        HTTP_PORT=$((HTTP_PORT + 1))
    done
    
    while netstat -tuln 2>/dev/null | grep -q ":$HTTPS_PORT " || lsof -i :$HTTPS_PORT 2>/dev/null | grep -q LISTEN; do
        HTTPS_PORT=$((HTTPS_PORT + 1))
    done
    
    echo "Using ports: SSH=$SSH_PORT, HTTP=$HTTP_PORT, HTTPS=$HTTPS_PORT"
    echo ""
    
    # Run with proper systemd support in detached mode
    docker run -d \
        --privileged \
        --cap-add=ALL \
        --cgroupns=host \
        -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
        --tmpfs /run \
        --tmpfs /run/lock \
        -p $SSH_PORT:22 \
        -p $HTTP_PORT:80 \
        -p $HTTPS_PORT:443 \
        --name pterodactyl-container \
        ubuntu24-systemd
    
    if [ $? -eq 0 ]; then
        echo ""
        echo "✓ Container started successfully!"
        echo ""
        echo "Access your container using one of these methods:"
        echo ""
        echo "1. Direct shell access:"
        echo "   docker exec -it pterodactyl-container /bin/bash"
        echo ""
        echo "2. SSH access (after starting SSH):"
        echo "   ssh root@localhost -p $SSH_PORT"
        echo "   Password: root"
        echo ""
        echo "3. Web access:"
        echo "   HTTP:  http://localhost:$HTTP_PORT"
        echo "   HTTPS: https://localhost:$HTTPS_PORT"
        echo ""
        echo "4. View logs:"
        echo "   docker logs pterodactyl-container"
        echo ""
        echo "To stop the container:"
        echo "   docker stop pterodactyl-container"
        echo ""
        echo "To start again:"
        echo "   docker start pterodactyl-container"
        echo ""
        echo "Now connecting to container..."
        sleep 3
        docker exec -it pterodactyl-container /bin/bash
    else
        echo "✗ Failed to start container"
        exit 1
    fi
else
    echo "✗ Build failed. Please check the errors above."
    exit 1
fi
